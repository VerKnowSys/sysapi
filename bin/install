#!/bin/sh


_uname="$(uname 2>/dev/null)"
_cwd="${PWD}"


case "${_uname}" in
    FreeBSD)
        echo "Building library: kvmpro"
        if [ ! -d ../kvmpro ]; then
            git clone https://github.com/VerKnowSys/kvmpro.git
            cd kvmpro
            bin/build
            cd "${_cwd}"
        else
            cd ../kvmpro
            git pull
            bin/build
            cd "${_cwd}"
        fi
        mkdir -p "${_cwd}/lib"
        install -v "../kvmpro/lib/libkvmpro.a" "${_cwd}/lib" || exit 3

        echo
        echo "Building and installing: SysAPI"
        git pull --jobs 4 && \
            cargo build --release && \
            killall sysapi 2>/dev/null
        strip -s -d target/release/sysapi
        install -v target/release/sysapi /usr/bin/sysapi && \
            echo "Successfully installed: SysAPI" && \
                exit 0
        ;;

    *)
        echo "Platform not supported: ${_uname}" && \
            exit 1
        ;;

esac
