#!/bin/sh
# blame: @dmilith
# 2018-12-10-0127-1544401657


# NOTE: Explicitly set "release" as default release type:
_rel_type="${1:-release}"

. bin/common "${_rel_type}"
if [ "release" = "${_rel_type}" ]; then
    bin/clean purge
else
    bin/clean
fi


strip_product () {
    echo "Strip: SysAPI: ${_bin_product_target}" \
        && strip -s -d "${_bin_product_target}" \
        && return 0

    return 1
}


disable_hardening_features () {
    echo "Setting up explicit hardening for: SysAPI"
    hbsdcontrol pax disable aslr "${_sysapi_dest_bin}" \
        && hbsdcontrol pax disable mprotect "${_sysapi_dest_bin}" \
        && hbsdcontrol pax disable pageexec "${_sysapi_dest_bin}" \
        && hbsdcontrol pax disable shlibrandom "${_sysapi_dest_bin}" \
        && hbsdcontrol pax enable segvguard "${_sysapi_dest_bin}" \
        && hbsdcontrol pax enable disallow_map32bit "${_sysapi_dest_bin}" \
        && return 0

    return 1
}


install_product () {
    killall -TERM "${_bin_name}" 2>/dev/null
    install -v "${_bin_product_target}" "${_sysapi_dest_bin}" \
        && disable_hardening_features \
        && echo "Installed: SysAPI binary: ${_bin_product_target}" \
        && return 0

    return 1
}


# Strip and Install product:
bin/build "${_rel_type}" \
    && strip_product \
    && install_product \
    && exit 0

exit 1
