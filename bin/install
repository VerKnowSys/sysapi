#!/bin/sh
# blame: @dmilith
# 2018-11-22-0129-1542846591


_kvmpro_repo="https://github.com/VerKnowSys/kvmpro.git"
_sysapi_dest_bin="/usr/bin/sysapi"
_uname="$(uname 2>/dev/null)"
_cwd="${PWD}"
_cargo_release_flag="--release"
_release_type="${1:-release}"
if [ "release" != "${_release_type}" ]; then
    unset _cargo_release_flag
fi


case "${_uname}" in
    FreeBSD)
        if [ ! -d ../kvmpro ]; then
            echo "Fetch repository: kvmpro"
            cd ..
            git clone --jobs=4 "${_kvmpro_repo}"
            cd kvmpro
        else
            echo "Update repository: kvmpro"
            cd ../kvmpro
            git pull --jobs=4
        fi
        bin/clean
        bin/install
        cd "${_cwd}"
        echo

        echo "Build: SysAPI"
        git pull --jobs 4 && \
            RUSTFLAGS="-lkvm -lprocstat" \
                cargo build ${_cargo_release_flag} && \
                    killall sysapi 2>/dev/null

        echo "Strip and Install: SysAPI"
        strip -s -d "target/${_release_type}/sysapi"
        install -v "target/${_release_type}/sysapi" "${_sysapi_dest_bin}" && \
            echo "Successfully installed: SysAPI" && \
                exit 0
        ;;

    *)
        echo "Platform not supported: ${_uname}" && \
            exit 1
        ;;

esac
